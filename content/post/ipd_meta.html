---
title: "Individual Participant Data Meta-Analysis: Example with R"
author: "Megha Joshi"
date: 2022-12-06
categories: ["R"]
tags: ["meta-analyis", "heterogeneity", "ipdma"]
output:
  html_document:
    toc: true
    toc_float: true
---



<div id="aggregated-data-meta-analysis-and-ipdma" class="section level2">
<h2>Aggregated Data Meta-Analysis and IPDMA</h2>
<p>Traditional meta-analyses use aggregated or summary level information from studies or reports (Cooper &amp; Patall, 2009; Riley et al., 2010). Analysts conducting aggregated data meta-analysis would look up relevant literature and code summary statistics needed to calculate one or more effect sizes from each study and also code the corresponding moderator variables. And, then run meta-regression models to (1) summarize effect size estimates across studies, (2) characterize variability in effect sizes across studies, and (3) explain the variability in the effect sizes. Moderator variables will be at the effect size-level or the study-level (e.g., the outcome measure or the percentage of economically disadvantaged students in the sample used to calculate the effect). One drawback of aggregated data meta-analysis is that we cannot examine the effect of moderators at the individual level. For example, we can say that studies with higher percentage of economically disadvantaged students tend to have higher effects of some treatment. However, we cannot say that the treatment works better for economically disadvantaged students. To do so would be to commit <a href="https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-021-01310-0">ecological fallacy</a> (Geissbühler et al., 2021).</p>
<p>Another way of conducting meta-analysis is to use individual participant-level data instead of aggregated summaries (Riley et al., 2010). For each study in the meta-analysis, the analyst would have access to the individual-level data. Outcomes and moderator variables will be at the individual level (e.g., students’ scores on an achievement test and indicator for whether or not they are economically disadvantaged). Because data is at the individual-level, analysts can conduct subgroup analyses to examine the potentially heterogeneous effects of a treatment for different subgroups (Cooper &amp; Patall, 2009). The feasibility of conducting such subgroup analyses provides IPDMA a major advantage over aggregated data meta-analysis, which heavily rely on the analyses conducted by primary study authors who may not have reported results from subgroup analyses.</p>
</div>
<div id="ipdma-analyses-in-r" class="section level2">
<h2>IPDMA Analyses in R</h2>
<p>There are two ways do conduct IPDMA: (1) one-stage meta-analysis which involves analyzing data from all studies at once; and, (2) two-stage meta-analysis which involves first analyzing individual data separately for each primary study and then synthesizing the effects using meta-regression models (Cooper &amp; Patall, 2009; Riley et al., 2010). I will walk through how to run each of these using an example data.</p>
<div id="example-dataset" class="section level3">
<h3>Example Dataset</h3>
<p>I’ve <a href="https://twitter.com/jepusto/status/1539286748034916353">tried to</a> find a publicly available IPDMA dataset to use as an example. However, I haven’t found one appropriate for this post. Thus, I am using a dataset is from a <a href="https://www.pnas.org/content/113/39/10830">block randomized study</a> (Bryan et al., 2016). Blocks can be somewhat thought of as different studies in a meta-analysis (not the same thing but please go along for this post). In the data, students were randomized within classes. There are 30 classrooms (like 30 different studies) within which participants were randomized. The study examined the effects of brief psychological interventions on eating behaviors. The outcome that I am going to analyze is <code>autonprosocial</code>, four-item self-report measure of alignment of healthy eating with adolescent values.</p>
<pre class="r"><code>library(tidyverse)
library(knitr)
library(estimatr)
library(metafor)
library(lme4)
library(lmerTest)
library(broom)
library(broom.mixed)
library(kableExtra)
library(janitor)

options(knitr.kable.NA = &#39;&#39;)

bryan_dat &lt;- read_csv(&quot;https://raw.githubusercontent.com/meghapsimatrix/datasets/master/causal/bryan_dat.csv&quot;)

glimpse(bryan_dat %&gt;% select(classroom, condition, condition_collapsed, female, autonprosocial))</code></pre>
<pre><code>## Rows: 501
## Columns: 5
## $ classroom           &lt;chr&gt; &quot;B2&quot;, &quot;B2&quot;, &quot;A1&quot;, &quot;A2&quot;, &quot;B3&quot;, &quot;A3&quot;, &quot;B4&quot;, &quot;B2&quot;, &quot;D…
## $ condition           &lt;chr&gt; &quot;expose treatment&quot;, &quot;expose treatment&quot;, &quot;no treatm…
## $ condition_collapsed &lt;chr&gt; &quot;expose treatment&quot;, &quot;expose treatment&quot;, &quot;control&quot;,…
## $ female              &lt;dbl&gt; 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1,…
## $ autonprosocial      &lt;dbl&gt; 3.75, 4.25, 2.25, 4.25, 3.25, 3.25, 4.25, 1.25, 2.…</code></pre>
</div>
<div id="one-stage-ipdma" class="section level3">
<h3>One Stage IPDMA</h3>
<p>One stage IPDMA basically involves running one analysis on all the data accounting for clustering by study. Below I am running HLM using <code>lmer()</code> from <a href="https://cran.r-project.org/web/packages/lme4/index.html"><code>lme4</code></a> package specifying fixed intercepts but random slopes for treatment effect by classroom. The model that I am using is based on suggestion by <a href="https://cpb-us-w2.wpmucdn.com/voices.uchicago.edu/dist/6/1063/files/2018/11/Using-Multisite-Experiments-to-UsingMultiSiteExperimentstoStudyJREE-R-2111j3e.pdf">Bloom et al. (2016)</a>. The results table shows the treatment effect estimate (and it’s se etc.) and also the estimate of the standard deviation of the treatment effects across classrooms.</p>
<pre class="r"><code># creating treatment indicator
bryan_dat &lt;-
  bryan_dat %&gt;%
  mutate(trt_ind = as.integer(condition_collapsed == &quot;expose treatment&quot;))


# function to estimate treatment effects
estimate_effects &lt;- function(dat, stage){
  
  if(stage == &quot;one&quot;){
    
    mod &lt;- lmer(autonprosocial ~ 0 + classroom + trt_ind + 
                (0 + trt_ind | classroom), 
                data = dat)
  
  } else if(stage == &quot;two&quot;) {
    
    mod &lt;- lm_robust(autonprosocial ~ trt_ind, data = dat)
    
  }
  
  res &lt;- tidy(mod) %&gt;%
    filter(str_detect(term, &quot;trt_ind&quot;)) %&gt;%
    clean_names() %&gt;%
    mutate(v = std_error^2)
  
  return(res)
  
}



# estimate of treatment effect and the sd of treatment effect across classrooms
estimate_effects(bryan_dat, stage = &quot;one&quot;) %&gt;%
  kable(digits = 3) </code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std_error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
p_value
</th>
<th style="text-align:right;">
v
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
fixed
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
trt_ind
</td>
<td style="text-align:right;">
1.157
</td>
<td style="text-align:right;">
0.083
</td>
<td style="text-align:right;">
14.014
</td>
<td style="text-align:right;">
25.776
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.007
</td>
</tr>
<tr>
<td style="text-align:left;">
ran_pars
</td>
<td style="text-align:left;">
classroom
</td>
<td style="text-align:left;">
sd__trt_ind
</td>
<td style="text-align:right;">
0.146
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
</tr>
</tbody>
</table>
<div id="subgroup-analyses" class="section level4">
<h4>Subgroup Analyses</h4>
<p>Below I am creating subgroups based on the <code>female</code> variable and estimating the treatment effect and the sd of treatment effects across classrooms for each subgroup:</p>
<pre class="r"><code>bryan_dat &lt;- bryan_dat %&gt;%
  mutate(female = ifelse(female == 1, &quot;Female&quot;, &quot;Not Female&quot;))

bryan_dat %&gt;%
  group_by(female) %&gt;%
  do(estimate_effects(., stage = &quot;one&quot;)) %&gt;%
  kable(digits = 3)</code></pre>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)
## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
female
</th>
<th style="text-align:left;">
effect
</th>
<th style="text-align:left;">
group
</th>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std_error
</th>
<th style="text-align:right;">
statistic
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
p_value
</th>
<th style="text-align:right;">
v
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Female
</td>
<td style="text-align:left;">
fixed
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
trt_ind
</td>
<td style="text-align:right;">
1.217
</td>
<td style="text-align:right;">
0.109
</td>
<td style="text-align:right;">
11.187
</td>
<td style="text-align:right;">
232
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.012
</td>
</tr>
<tr>
<td style="text-align:left;">
Female
</td>
<td style="text-align:left;">
ran_pars
</td>
<td style="text-align:left;">
classroom
</td>
<td style="text-align:left;">
sd__trt_ind
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Not Female
</td>
<td style="text-align:left;">
fixed
</td>
<td style="text-align:left;">
</td>
<td style="text-align:left;">
trt_ind
</td>
<td style="text-align:right;">
1.043
</td>
<td style="text-align:right;">
0.115
</td>
<td style="text-align:right;">
9.058
</td>
<td style="text-align:right;">
207
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.013
</td>
</tr>
<tr>
<td style="text-align:left;">
Not Female
</td>
<td style="text-align:left;">
ran_pars
</td>
<td style="text-align:left;">
classroom
</td>
<td style="text-align:left;">
sd__trt_ind
</td>
<td style="text-align:right;">
0.000
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
<td style="text-align:right;">
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="two-stage-ipdma" class="section level3">
<h3>Two Stage IPDMA</h3>
<div id="first-stage-primary-study-analysis" class="section level4">
<h4>First Stage: Primary Study Analysis</h4>
<p>First, I estimate the average treatment effect by block. For IPDMA, we would estimate the treatment effects for each primary study:</p>
<pre class="r"><code>first_stage_res &lt;-
  bryan_dat %&gt;%
  group_by(classroom) %&gt;%
  do(estimate_effects(., stage = &quot;two&quot;)) 

glimpse(first_stage_res)</code></pre>
<pre><code>## Rows: 30
## Columns: 11
## Groups: classroom [30]
## $ classroom &lt;chr&gt; &quot;A1&quot;, &quot;A2&quot;, &quot;A3&quot;, &quot;A4&quot;, &quot;A5&quot;, &quot;A6&quot;, &quot;B1&quot;, &quot;B2&quot;, &quot;B3&quot;, &quot;B4&quot;, …
## $ term      &lt;chr&gt; &quot;trt_ind&quot;, &quot;trt_ind&quot;, &quot;trt_ind&quot;, &quot;trt_ind&quot;, &quot;trt_ind&quot;, &quot;trt_…
## $ estimate  &lt;dbl&gt; 1.7951128, 1.4062500, 0.1250000, 0.9318182, 0.9130952, 1.333…
## $ std_error &lt;dbl&gt; 0.2744876, 0.2830958, 0.3683758, 0.2781655, 0.3595215, 0.496…
## $ statistic &lt;dbl&gt; 6.5398688, 4.9673998, 0.3393274, 3.3498700, 2.5397511, 2.687…
## $ p_value   &lt;dbl&gt; 9.175979e-07, 3.266890e-04, 7.387762e-01, 4.386511e-03, 2.11…
## $ conf_low  &lt;dbl&gt; 1.2285983, 0.7894372, -0.6559219, 0.3389225, 0.1545711, 0.28…
## $ conf_high &lt;dbl&gt; 2.3616273, 2.0230628, 0.9059219, 1.5247139, 1.6716194, 2.380…
## $ df        &lt;dbl&gt; 24, 12, 16, 15, 17, 17, 7, 32, 26, 19, 16, 10, 12, 11, 18, 1…
## $ outcome   &lt;chr&gt; &quot;autonprosocial&quot;, &quot;autonprosocial&quot;, &quot;autonprosocial&quot;, &quot;auton…
## $ v         &lt;dbl&gt; 0.07534343, 0.08014323, 0.13570076, 0.07737603, 0.12925574, …</code></pre>
</div>
<div id="second-stage-meta-analysis" class="section level4">
<h4>Second Stage: Meta-Analysis</h4>
<p>Then, in the second stage, I synthesize the block specific treatment effects using <a href="https://wviechtb.github.io/metafor/reference/rma.uni.html">metafor::rma.uni()</a>, which weighs each effect size estimate by its precision:</p>
<pre class="r"><code>second_stage_res &lt;- rma.uni(yi = estimate, 
                            sei = std_error,
                            data = first_stage_res, 
                            method = &quot;REML&quot;, 
                            test = &quot;knha&quot;)

tibble(
  rowname = rownames(second_stage_res$b),
  estimate = as.vector(second_stage_res$b),
  SE = second_stage_res$se,
  ci_lo = second_stage_res$ci.lb,
  ci_hi = second_stage_res$ci.ub,
  tau_2 = second_stage_res$tau2
) %&gt;%
  kable(digits = 3)</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
rowname
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
SE
</th>
<th style="text-align:right;">
ci_lo
</th>
<th style="text-align:right;">
ci_hi
</th>
<th style="text-align:right;">
tau_2
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
intrcpt
</td>
<td style="text-align:right;">
1.214
</td>
<td style="text-align:right;">
0.088
</td>
<td style="text-align:right;">
1.034
</td>
<td style="text-align:right;">
1.394
</td>
<td style="text-align:right;">
0.13
</td>
</tr>
</tbody>
</table>
</div>
<div id="subgroup-analyses-1" class="section level4">
<h4>Subgroup Analyses</h4>
</div>
<div id="first-stage-primary-study-analysis-1" class="section level4">
<h4>First Stage: Primary Study Analysis</h4>
<p>Here, I estimate treatment effect by classroom and by the female variable:</p>
<pre class="r"><code>subgroup_fs_res &lt;- bryan_dat %&gt;%
  group_by(classroom, female) %&gt;%
  do(estimate_effects(., stage = &quot;two&quot;))</code></pre>
<pre><code>## 1 coefficient  not defined because the design matrix is rank deficient</code></pre>
</div>
<div id="second-stage-meta-analysis-1" class="section level4">
<h4>Second Stage: Meta-Analysis</h4>
<p>Then, in the second stage, I synthesize the block specific subgroup effects.</p>
<pre class="r"><code>estimate_subgroup_mod &lt;- function(dat){
  
  second_stage_res &lt;- rma.uni(yi = estimate, 
                              sei = std_error,
                              data = dat, 
                              method = &quot;REML&quot;, 
                              test = &quot;knha&quot;)
  
  res &lt;- tibble(
      rowname = rownames(second_stage_res$b),
      est = as.vector(second_stage_res$b),
      SE = second_stage_res$se,
      ci_lo = second_stage_res$ci.lb,
      ci_hi = second_stage_res$ci.ub,
      tau_2 = second_stage_res$tau2
    )

  return(res)
  
}
  
subgroup_fs_res %&gt;%
  group_by(female) %&gt;%
  do(estimate_subgroup_mod(.)) %&gt;%
  kable(digits = 3)</code></pre>
<pre><code>## Warning: Studies with NAs omitted from model fitting.

## Warning: Studies with NAs omitted from model fitting.</code></pre>
<table>
<thead>
<tr>
<th style="text-align:left;">
female
</th>
<th style="text-align:left;">
rowname
</th>
<th style="text-align:right;">
est
</th>
<th style="text-align:right;">
SE
</th>
<th style="text-align:right;">
ci_lo
</th>
<th style="text-align:right;">
ci_hi
</th>
<th style="text-align:right;">
tau_2
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Female
</td>
<td style="text-align:left;">
intrcpt
</td>
<td style="text-align:right;">
1.234
</td>
<td style="text-align:right;">
0.124
</td>
<td style="text-align:right;">
0.979
</td>
<td style="text-align:right;">
1.489
</td>
<td style="text-align:right;">
0.290
</td>
</tr>
<tr>
<td style="text-align:left;">
Not Female
</td>
<td style="text-align:left;">
intrcpt
</td>
<td style="text-align:right;">
1.179
</td>
<td style="text-align:right;">
0.101
</td>
<td style="text-align:right;">
0.972
</td>
<td style="text-align:right;">
1.387
</td>
<td style="text-align:right;">
0.171
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Bates, D., Maechler, M., Bolker, B. &amp; Walker, S. (2015). Fitting Linear Mixed-Effects Models Using lme4. Journal of Statistical Software, 67(1), 1-48. <a href="doi:10.18637/jss.v067.i01" class="uri">doi:10.18637/jss.v067.i01</a>.</p>
<p>Bryan, C. J., Yeager, D. S., Hinojosa, C. P., Chabot, A., Bergen, H., Kawamura, M., &amp; Steubing, F. (2016). Harnessing adolescent values to motivate healthier eating. <em>Proceedings of the National Academy of Sciences</em>, <em>113</em>(39), 10830-10835.</p>
<p>Cooper, H., &amp; Patall, E. A. (2009). The relative benefits of meta-analysis conducted with individual participant data versus aggregated data. <em>Psychological methods</em>, <em>14</em>(2), 165.</p>
<p>Geissbühler, M., Hincapié, C.A., Aghlmandi, S. <em>et al.</em> Most published meta-regression analyses based on aggregate data suffer from methodological pitfalls: a meta-epidemiological study. <em>BMC Med Res Methodol</em> <strong>21</strong>, 123 (2021). <a href="https://doi.org/10.1186/s12874-021-01310-0" class="uri">https://doi.org/10.1186/s12874-021-01310-0</a></p>
<p>Riley, R. D., Lambert, P. C., &amp; Abo-Zaid, G. (2010). Meta-analysis of individual participant data: rationale, conduct, and reporting. <em>Bmj</em>, <em>340</em>.</p>
<p>Viechtbauer, W. (2010). Conducting meta-analyses in R with the metafor package. Journal of Statistical Software, 36(3), 1-48. <a href="https://doi.org/10.18637/jss.v036.i03" class="uri">https://doi.org/10.18637/jss.v036.i03</a></p>
<p>Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). “Welcome to the tidyverse.” _Journal of Open Source Software_, *4*(43), 1686. <a href="doi:10.21105/joss.01686" class="uri">doi:10.21105/joss.01686</a> <a href="https://doi.org/10.21105/joss.01686" class="uri">https://doi.org/10.21105/joss.01686</a>.</p>
</div>
